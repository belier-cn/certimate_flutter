name: Release

on:
  push:
    tags:
      - "v[0-9]*"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        type: [ android, ios, macos, windows, linux, web, ohos ]
        include:
          - type: android
            os: ubuntu-latest
            flutter: 3.38.9
          - type: ios
            os: macos-latest
            flutter: 3.38.9
          - type: macos
            os: macos-latest
            flutter: 3.38.9
          - type: windows
            os: windows-latest
            flutter: 3.38.9
          - type: linux
            os: ubuntu-22.04
            flutter: 3.38.9
          - type: web
            os: ubuntu-latest
            flutter: 3.38.9
          - type: ohos
            os: ubuntu-latest
            flutter: oh-3.35.7-dev

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Java 17 development environment
        uses: actions/setup-java@v4
        if: ${{ matrix.type == 'android' || matrix.type == 'ohos' }}
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Node.js 20 runtime
        uses: actions/setup-node@v6
        if: ${{ matrix.type == 'macos' }}
        with:
          node-version: 20

      - name: Setup Flutter SDK ${{ matrix.flutter }}
        if: ${{ matrix.type != 'ohos' }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter }}
          channel: "stable"

      - name: Apply Flutter Cupertino navigation bar patch
        if: ${{ matrix.type != 'ohos' }}
        shell: bash
        run: |
          echo "Flutter root: $FLUTTER_ROOT"
          target="$FLUTTER_ROOT/packages/flutter/lib/src/cupertino/nav_bar.dart"
          echo "Patching $target"
          curl -fsSL "https://github.com/belier-cn/certimate_flutter/releases/download/v0.0.1/cupertino_nav_bar_${{ matrix.flutter }}.dart" -o "$target"

      - name: Download and setup HarmonyOS command-line tools
        if: ${{ matrix.type == 'ohos' }}
        run: |
          FILE_NAME="commandline-tools-linux-x64-6.0.1.251.zip"
          wget -c -q -P "$HOME" "https://github.com/belier-cn/flutter_ohos_packages/releases/download/v0.0.1/${FILE_NAME}.aa" || exit 1
          wget -c -q -P "$HOME" "https://github.com/belier-cn/flutter_ohos_packages/releases/download/v0.0.1/${FILE_NAME}.ab" || exit 1
          cat "$HOME/${FILE_NAME}.a"* > "$HOME/${FILE_NAME}"
          unzip -q "$HOME/${FILE_NAME}" -d "$HOME"
          echo "$HOME/command-line-tools/bin" >> $GITHUB_PATH
          export PATH="$HOME/command-line-tools/bin:$PATH"
          ohpm -v
          rm -rf "${FILE_NAME}"*

      - name: Setup HarmonyOS Flutter SDK
        if: ${{ matrix.type == 'ohos' }}
        run: |
          cat pubspec_ohos_overrides.yaml >> pubspec.yaml
          rm -rf pubspec.lock
          git config --global http.postBuffer 1048576000
          git clone --branch ${{ matrix.flutter }} https://gitcode.com/openharmony-tpc/flutter_flutter.git "$HOME/harmony_flutter"
          echo "$HOME/harmony_flutter/bin" >> $GITHUB_PATH
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          export PATH="$HOME/harmony_flutter/bin:$PATH"
          flutter --version
          flutter config --ohos-sdk="$HOME/command-line-tools/sdk"

      - name: Install Flutter project dependencies
        run: |
          flutter pub global activate fastforge
          flutter pub get
          flutter pub run intl_utils:generate
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Android APK package
        if: ${{ matrix.type == 'android' }}
        run: |
          echo -n "$KEYSTORE_BASE64" | openssl base64 -d -A > android/app/certimate.jks
          fastforge package --platform android --targets apk --artifact-name certimate-${{ github.ref_name }}-${{ matrix.type }}.apk
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
          KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}

      - name: Build iOS IPA package (unsigned)
        if: ${{ matrix.type == 'ios' }}
        run: |
          wget -c -q -O fastforge "https://github.com/belier-cn/fastforge/releases/download/v0.6.7-beta.1/fastforge-v0.6.7-beta.1-macos-arm64" || exit 1
          chmod +x fastforge
          ./fastforge package --platform ios --targets ipa --flutter-build-args no-codesign --artifact-name certimate-${{ github.ref_name }}-${{ matrix.type }}.ipa

      - name: Build macOS DMG installer
        if: ${{ matrix.type == 'macos' }}
        run: |
          npm install -g appdmg
          fastforge package --platform macos --targets dmg --artifact-name certimate-${{ github.ref_name }}-${{ matrix.type }}.dmg

      - name: Build Windows EXE installer
        if: ${{ matrix.type == 'windows' }}
        run: |
          choco upgrade innosetup --no-progress
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/ChineseSimplified.isl" -OutFile "C:\Program Files (x86)\Inno Setup 6\Languages\ChineseSimplified.isl"
          fastforge package --platform windows --targets exe --artifact-name certimate-${{ github.ref_name }}-${{ matrix.type }}.exe

      - name: Install basic Linux build dependencies
        if: ${{ matrix.type == 'linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libsecret-1-dev libfuse2 locate

      - name: Restore WPE WebKit from cache
        if: ${{ matrix.type == 'linux' }}
        id: cache-wpe
        uses: actions/cache@v4
        with:
          path: /usr/local
          key: wpe-webkit-2.50.4-ubuntu-${{ runner.os }}-${{ runner.arch }}

      # https://github.com/pichillilorenzo/flutter_inappwebview/blob/master/flutter_inappwebview_linux/WPE_BACKEND.md
      - name: Install WPE WebKit build dependencies
        if: ${{ matrix.type == 'linux' && steps.cache-wpe.outputs.cache-hit != 'true' }}
        run: |
          # Core build tools
          sudo apt-get install -y \
          build-essential cmake ninja-build meson pkg-config \
          ruby ruby-dev python3 python3-pip \
          gperf unifdef
          
          # GLib (required)
          sudo apt-get install -y libglib2.0-dev

          # GObject Introspection (required for ENABLE_INTROSPECTION)
          sudo apt-get install gobject-introspection libunwind-dev libgirepository1.0-dev

          # Networking and security (required)
          sudo apt-get install -y \
          libsoup-3.0-dev \
          libssl-dev libgnutls28-dev \
          libsecret-1-dev \
          libgcrypt20-dev libtasn1-dev
          
          # Graphics and rendering (required)
          sudo apt-get install -y \
          libepoxy-dev \
          libegl1-mesa-dev libgles2-mesa-dev \
          libxkbcommon-dev
          
          # Image and font processing (required)
          sudo apt-get install -y \
          libjpeg-dev libpng-dev libwebp-dev \
          libharfbuzz-dev libharfbuzz-icu0 libfreetype6-dev libfontconfig1-dev
          
          # Text and internationalization (required)
          sudo apt-get install -y \
          libicu-dev libxml2-dev \
          libhyphen-dev libenchant-2-dev
          
          # Media and audio (required for ENABLE_VIDEO and ENABLE_WEB_AUDIO)
          sudo apt-get install -y \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev \
          libgstreamer-plugins-bad1.0-dev \
          gstreamer1.0-plugins-base gstreamer1.0-plugins-good
          
          # Database and storage (required)
          sudo apt-get install -y libsqlite3-dev
          
          # WPE libraries (required)
          sudo apt-get install -y libwpe-1.0-dev

      - name: Build WPE WebKit 2.50.4 from source
        if: ${{ matrix.type == 'linux' && steps.cache-wpe.outputs.cache-hit != 'true' }}
        run: |
          export WPE_PREFIX=/usr/local
          export CC=clang
          export CXX=clang++
          cd /tmp

          # Build libwpe
          wget -q https://wpewebkit.org/releases/libwpe-1.16.3.tar.xz
          tar xf libwpe-1.16.3.tar.xz
          cd libwpe-1.16.3
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$WPE_PREFIX \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++
          sudo ninja -C build install

          # Build WPE WebKit
          cd /tmp
          wget -q https://wpewebkit.org/releases/wpewebkit-2.50.4.tar.xz
          tar xf wpewebkit-2.50.4.tar.xz
          cd wpewebkit-2.50.4
          cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=$WPE_PREFIX \
          -DPORT=WPE \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DUSE_JPEGXL=OFF \
          -DUSE_AVIF=OFF \
          -DUSE_WOFF2=OFF \
          -DUSE_LCMS=OFF \
          -DUSE_ATK=OFF \
          -DUSE_LIBBACKTRACE=OFF \
          -DENABLE_SPEECH_SYNTHESIS=OFF \
          -DENABLE_DOCUMENTATION=OFF \
          -DENABLE_INTROSPECTION=OFF \
          -DENABLE_JOURNALD_LOG=OFF \
          -DENABLE_BUBBLEWRAP_SANDBOX=OFF \
          -DENABLE_WEBDRIVER=OFF \
          -DENABLE_GAMEPAD=OFF \
          -DUSE_GSTREAMER_WEBRTC=OFF \
          -DENABLE_MINIBROWSER=OFF \
          -DENABLE_WPE_PLATFORM=ON \
          -DENABLE_WPE_PLATFORM_HEADLESS=ON
          sudo ninja -C build install
          sudo ldconfig

      - name: Build Linux AppImage package
        if: ${{ matrix.type == 'linux' }}
        run: |
          wget -c -q -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" || exit 1
          chmod +x appimagetool
          sudo mv appimagetool /usr/local/bin/
          fastforge package --platform linux --targets appimage --artifact-name certimate-${{ github.ref_name }}-${{ matrix.type }}.appimage

      - name: Build HarmonyOS HAP package
        if: ${{ matrix.type == 'ohos' }}
        run: |
          echo -n "$HARMONY_SIGNING_BASE64" | openssl base64 -d -A > ohos/signing-configs.json
          echo -n "$HARMONY_SIGNING_FILE_BASE64" | openssl base64 -d -A > ohos/signature.zip
          unzip -q ohos/signature.zip -d ohos
          fastforge package --platform ohos --targets hap --artifact-name certimate-${{ github.ref_name }}-${{ matrix.type }}.hap
        env:
          HARMONY_SIGNING_BASE64: ${{ secrets.HARMONY_SIGNING_BASE64 }}
          HARMONY_SIGNING_FILE_BASE64: ${{ secrets.HARMONY_SIGNING_FILE_BASE64 }}

      - name: Build web application bundle
        if: ${{ matrix.type == 'web' }}
        run: |
          flutter build web --release --base-href /${{ github.event.repository.name }}/ --dart-define FLUTTER_BASE_HREF=/${{ github.event.repository.name }}/
          cp build/web/index.html build/web/404.html
          mkdir -p "dist/${{ github.ref_name }}"
          tar -cvf dist/${{ github.ref_name }}/certimate-${{ github.ref_name }}-web.tar -C build/web .

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.type }}
          retention-days: 1
          path: |
            dist/**/*.apk
            dist/**/*.ipa
            dist/**/*.hap
            dist/**/*.dmg
            dist/**/*.exe
            dist/**/*.tar
            dist/**/*.appimage

  release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release draft
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
